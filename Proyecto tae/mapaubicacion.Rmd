---
title: "Mapas ubicacion"
author: "Edwin Caicedo"
date: "23 de febrero de 2018"
output: html_document
---
```{r}
library(rgdal)
library(leaflet)
library(raster)
library(leaflet.extras)
library(colorRamps)
```

Lectura de bases
```{r}
Base3 <- shapefile("Accidentalidad_2017.shp",encoding="UTF-8",use_iconv=TRUE)
barmed<- shapefile("Barrio_Vereda.shp",encoding="UTF-8",use_iconv=TRUE)
```

Mapa de barrios de Medellín 
```{r}
colores<-sample(x=c("orange","green","yellow"),size=length(barmed@data$NOMBRE),replace=TRUE)
medbar<-leaflet(barmed)
medbar<-addProviderTiles(medbar,provider="OpenStreetMap.Mapnik")
medbar<-addPolygons(medbar,popup=barmed@data$NOMBRE,color=colores,weight = 1)

```

Accidentes en cada barrio
Como el objetivo es proyectar los puntos de los accidentes en los barrios, se asigna al objeto accidentalidad el sistema de referencia del objeto barmed. Esto se hace con el comando proj4string():
```{r}
proj4string(Base3) <- proj4string(barmed)

#Ahora, ya se pueden proyectar los puntos de los accidentes a los barrios de Medellín. Esto se hace #con el comando over():
comuna_ocurrencia<-over(Base3, barmed)

#El dataframe comuna_ocurrencia contiene la proyección de los puntos en los barrios. Es decir, que a #cada punto en el objeto accidentalidad se le asignó un polígono (barrio) del objeto barmed. Con #el comando table() se puede consolidar el número de veces que cada barrio aparece asociado a un #accidente:
freq_acc_comuna<-table(comuna_ocurrencia$NOMBRE)
freq_acc_comuna<-as.data.frame(freq_acc_comuna)

#A continuación se enriquece el objeto barmed con la columna cant_acc en el dataframe barmed@data. A cada barrio se le asigna el número de accidentes encontrados:
id_x<-match(barmed@data$NOMBRE,freq_acc_comuna$Var1)
barmed@data$cant_acc<-freq_acc_comuna$Freq[id_x]
```

Ahora se creará el mapa de los barrios con la información de accidentalidad. Primero se creará una escala de colores y una leyenda para cada barrio que contenga el nombre del barrio y los accidentes registrados:
```{r}
pal <-colorNumeric(palette=blue2red(596),domain=c(1,596))
popup<-paste(barmed@data$NOMBRE,paste(barmed@data$cant_acc," accidentes"),sep="<br/>")

accidentes_barrios<-leaflet(barmed)
accidentes_barrios<-addProviderTiles(accidentes_barrios,provider="OpenStreetMap.Mapnik")
accidentes_barrios<-addPolygons(accidentes_barrios,
               popup=popup,
               color=pal(barmed@data$cant_acc),
               opacity = 0.5,
               fillOpacity = 0.5,
               weight = 1)
accidentes_barrios<-addLegend(accidentes_barrios,"topright",pal=pal,values=barmed@data$cant_acc, 
             title="Cantidad de accidentes",
             opacity = 1)
accidentes_barrios
```

